@startuml
skinparam participantPadding 20
skinparam boxPadding 10

actor "<u>:Quản lý" as Admin
boundary "<u>:Giao diện\n<u>Báo cáo" as ReportUI
control "<u>:Hệ thống\n<u>Báo cáo" as ReportSystem
control "<u>:Hệ thống\n<u>Thống kê" as StatSystem
control "<u>:Hệ thống\n<u>Thông báo" as NotificationSystem
control "<u>:Hệ thống\n<u>Xuất file" as ExportSystem
entity "<u>:Cơ sở dữ liệu\n<u>Điểm số" as ScoreDB
entity "<u>:Cơ sở dữ liệu\n<u>Bài tập" as ExerciseDB
entity "<u>:Cơ sở dữ liệu\n<u>Chuyên cần" as AttendanceDB
entity "<u>:Cơ sở dữ liệu\n<u>Người dùng" as UserDB

== Báo cáo điểm số ==
Admin -> ReportUI : 1. Chọn "Báo cáo điểm số"
activate ReportUI
ReportUI -> ReportSystem : 2. Yêu cầu trang báo cáo điểm số
activate ReportSystem
ReportSystem -> ScoreDB : 3. Lấy danh sách lớp/học viên
activate ScoreDB
ScoreDB --> ReportSystem : 4. Trả về danh sách
deactivate ScoreDB
ReportSystem --> ReportUI : 5. Hiển thị form chọn lớp/cá nhân
ReportUI --> Admin : 6. Hiển thị danh sách lựa chọn
deactivate ReportUI

Admin -> ReportUI : 7. Chọn lớp/cá nhân cần báo cáo
activate ReportUI
ReportUI -> ReportSystem : 8. Gửi yêu cầu tổng hợp điểm số
ReportSystem -> ScoreDB : 9. Truy vấn điểm số theo tiêu chí
activate ScoreDB
ScoreDB --> ReportSystem : 10. Trả về dữ liệu điểm số
deactivate ScoreDB
ReportSystem -> StatSystem : 11. Tính toán thống kê
activate StatSystem
StatSystem --> ReportSystem : 12. Trả về kết quả thống kê
deactivate StatSystem
ReportSystem --> ReportUI : 13. Hiển thị báo cáo điểm số
ReportUI --> Admin : 14. Hiển thị báo cáo và tùy chọn xuất
deactivate ReportUI

Admin -> ReportUI : 15. Chọn xuất báo cáo (Excel/PDF)
activate ReportUI
ReportUI -> ExportSystem : 16. Yêu cầu xuất file
activate ExportSystem
ExportSystem --> ReportUI : 17. Trả về file xuất
deactivate ExportSystem
ReportUI --> Admin : 18. Tải file báo cáo
deactivate ReportUI
deactivate ReportSystem

== Thống kê bài tập ==
Admin -> ReportUI : 19. Chọn "Thống kê bài tập"
activate ReportUI
ReportUI -> StatSystem : 20. Yêu cầu thống kê bài tập
activate StatSystem
StatSystem -> ExerciseDB : 21. Lấy dữ liệu hoàn thành bài tập
activate ExerciseDB
ExerciseDB --> StatSystem : 22. Trả về dữ liệu bài tập
deactivate ExerciseDB
StatSystem -> StatSystem : 23. Tính tỷ lệ hoàn thành
StatSystem --> ReportUI : 24. Trả về thống kê bài tập
ReportUI --> Admin : 25. Hiển thị thống kê và tùy chọn xuất
deactivate ReportUI

Admin -> ReportUI : 26. Chọn xuất báo cáo chi tiết
activate ReportUI
ReportUI -> ExportSystem : 27. Yêu cầu xuất báo cáo bài tập
activate ExportSystem
ExportSystem --> ReportUI : 28. Trả về file báo cáo
deactivate ExportSystem
ReportUI --> Admin : 29. Tải file báo cáo
deactivate ReportUI
deactivate StatSystem

== Báo cáo chuyên cần ==
Admin -> ReportUI : 30. Chọn "Báo cáo chuyên cần"
activate ReportUI
ReportUI -> ReportSystem : 31. Yêu cầu báo cáo chuyên cần
activate ReportSystem
ReportSystem -> AttendanceDB : 32. Lấy dữ liệu điểm danh
activate AttendanceDB
AttendanceDB --> ReportSystem : 33. Trả về dữ liệu chuyên cần
deactivate AttendanceDB
ReportSystem -> StatSystem : 34. Tính thống kê chuyên cần
activate StatSystem
StatSystem --> ReportSystem : 35. Trả về thống kê (vắng/đủ)
deactivate StatSystem
ReportSystem --> ReportUI : 36. Hiển thị báo cáo chuyên cần
ReportUI --> Admin : 37. Hiển thị thống kê chuyên cần
deactivate ReportUI
deactivate ReportSystem

== Gửi thông báo chung ==
Admin -> ReportUI : 38. Chọn "Gửi thông báo chung"
activate ReportUI
ReportUI -> NotificationSystem : 39. Yêu cầu form thông báo
activate NotificationSystem
NotificationSystem -> UserDB : 40. Lấy danh sách nhóm người dùng
activate UserDB
UserDB --> NotificationSystem : 41. Trả về danh sách nhóm
deactivate UserDB
NotificationSystem --> ReportUI : 42. Hiển thị form nhập thông báo
ReportUI --> Admin : 43. Hiển thị form và danh sách đối tượng
deactivate ReportUI

Admin -> ReportUI : 44. Nhập nội dung và chọn đối tượng
activate ReportUI
ReportUI -> NotificationSystem : 45. Gửi yêu cầu gửi thông báo
NotificationSystem -> UserDB : 46. Lấy thông tin người nhận
activate UserDB
UserDB --> NotificationSystem : 47. Trả về danh sách người nhận
deactivate UserDB
NotificationSystem -> NotificationSystem : 48. Gửi thông báo/email
NotificationSystem -> UserDB : 49. Lưu lịch sử thông báo
activate UserDB
UserDB --> NotificationSystem : 50. Xác nhận lưu lịch sử
deactivate UserDB
NotificationSystem --> ReportUI : 51. Trả về kết quả gửi thành công
ReportUI --> Admin : 52. Hiển thị thông báo gửi thành công
deactivate ReportUI
deactivate NotificationSystem

== Luồng ngoại lệ ==
note over ScoreDB, AttendanceDB : **Ngoại lệ: Không có dữ liệu**\nNếu không có dữ liệu điểm số/bài tập/chuyên cần\nHệ thống thông báo "Không có dữ liệu để hiển thị"

note over NotificationSystem : **Ngoại lệ: Lỗi gửi thông báo**\nKhi gửi thông báo bị lỗi kết nối\nHệ thống thông báo "Gửi thất bại, vui lòng thử lại"

@enduml